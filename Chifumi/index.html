<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chifumi Multijoueur</title>
  <!-- Polices : Titre en Gloria Hallelujah, le reste en Source Code Pro -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&family=Source+Code+Pro&display=swap" rel="stylesheet"/>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* Corps en Source Code Pro, texte agrandi */
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding-top: 70px;
      background: #0e0e0e url('https://www.transparenttextures.com/patterns/black-linen.png');
      font-family: 'Source Code Pro', monospace;
      color: #fff;
      font-size: 18px; /* texte agrandi */
    }
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      display: flex; justify-content: center; align-items: center;
      gap: 20px; padding: 20px;
      background-color: #0e0e0e; z-index: 10000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      height: 80px;
    }
    .header-logo {
      width: 60px; height: 60px; object-fit: cover;
    }
    .return-button {
      margin-left: auto; padding: 10px 20px; font-size: 1rem;
      background-color: #b45502; color: #fff; border: none; border-radius: 5px;
      cursor: pointer; transition: background 0.3s ease; text-decoration: none;
    }
    .return-button:hover { background-color: #ff4500; }
    .game-container {
      margin: 20px; padding: 20px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 10px; text-align: center;
      max-width: 600px; width: 100%;
    }
    /* Titre en Gloria Hallelujah */
    h1 {
      font-family: 'Gloria Hallelujah', cursive;
      font-size: 3.2rem; /* un peu plus grand */
      font-weight: bold;
      background: linear-gradient(90deg, red, yellow);
      background-size: 200% 100%;
      background-clip: text; -webkit-background-clip: text;
      color: transparent; animation: gradientShift 3s infinite alternate;
      margin-bottom: 10px;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 0; }
      100% { background-position: 100% 0; }
    }
    #connection-section {
      display: flex; flex-direction: column; align-items: center;
      gap: 10px; margin-bottom: 20px; padding: 20px;
      background-color: rgba(255,255,255,0.1); border-radius: 10px;
    }
    #connection-section button,
    #connection-section input {
      padding: 10px 20px; border-radius: 5px; border: 2px solid #b45502;
      background-color: #b45502; color: #fff; cursor: pointer;
      transition: background 0.3s ease, border-color 0.3s ease;
      font-family: inherit;
    }
    /* On augmente la largeur de l’input et on centre le placeholder */
    #connection-section input {
      background: transparent; outline: none;
      width: 250px; /* Largeur augmentée */
      text-align: center; /* Placeholder centré */
    }
    #connection-section input:focus {
      border-color: #ff4500;
    }
    #status { margin-top: 10px; }
    #server-info {
      margin-top: 10px; font-size: 0.9rem; opacity: 0.8; line-height: 1.3;
    }
    /* Section Chifumi */
    #chifumi-game { margin-top: 20px; }
    #player-info { font-size: 1.2rem; margin-bottom: 10px; }
    #chifumi-turn { font-size: 1.2rem; margin: 10px 0; }
    #opponent-status { font-size: 1rem; margin: 5px 0 15px 0; }
    #choices {
      margin: 20px auto; display: flex; gap: 10px; justify-content: center;
    }
    #choices button {
      padding: 12px 24px; border: 2px solid #b45502;
      background-color: #b45502; color: #fff; cursor: pointer;
      border-radius: 5px; transition: background 0.3s ease;
      font-family: inherit; font-size: 1.1rem;
    }
    #choices button:hover {
      background-color: #ff4500;
    }
    #chifumi-result {
      margin-top: 15px; font-size: 1.4rem;
      font-weight: bold;
    }
    /* Bouton Rejouer */
    #chifumi-restart {
      margin: 20px auto 0; display: block; padding: 12px 24px;
      background: linear-gradient(45deg, #1E90FF, #00BFFF);
      color: #fff; border: none; border-radius: 6px; cursor: pointer;
      font-size: 1.2rem; font-family: 'Source Code Pro', monospace;
      font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
      transition: background 0.3s ease;
    }
    #chifumi-restart:hover {
      background: linear-gradient(45deg, #1E90FF, #009ACD);
    }
    button:disabled { background-color: #666; cursor: not-allowed; }
    /* Responsive mobile */
    @media (max-width: 500px) {
      h1 { font-size: 2.2rem; }
      #choices button { font-size: 1rem; padding: 10px 20px; }
      #chifumi-result { font-size: 1.2rem; }
    }
  </style>
</head>
<body>
  <header>
    <a href="../index.html">
      <img src="../Sources/Images/jerome.png" alt="Logo" class="header-logo">
    </a>
    <a href="../Projet/index.html" class="return-button">Mes projets</a>
  </header>
  
  <div class="game-container">
    <h1>Chifumi</h1>
    <div id="connection-section">
      <!-- Placeholder corrigé avec l'accent sur "hôte" -->
      <button id="createLink">Créer une partie</button>
      <input id="inviteCode" placeholder="Entrer l'ID de l'hôte">
      <button id="joinGame">Rejoindre</button>
      <p id="status">Statut : En attente...</p>
      <p id="server-info">
        Parfois, les serveurs sont surchargés.<br>
        Si une erreur survient (surtout sur mobile),<br>
        l’hôte doit relancer la partie.
      </p>
    </div>
    <div id="chifumi-game" style="display: none;">
      <p id="player-info"></p>
      <p id="chifumi-turn">Faites votre choix !</p>
      <p id="opponent-status">L'autre joueur n'a pas encore choisi.</p>
      <div id="choices">
        <button onclick="selectChoice('Pierre')">Pierre</button>
        <button onclick="selectChoice('Feuille')">Feuille</button>
        <button onclick="selectChoice('Ciseaux')">Ciseaux</button>
      </div>
      <p id="chifumi-result"></p>
      <button id="chifumi-restart" style="display: none;">Rejouer</button>
    </div>
  </div>
  
  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    // Configuration PeerJS avec serveur TURN gratuit
    let peer = new Peer({
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          {
            urls: "turn:openrelay.metered.ca:443",
            username: "openrelayproject",
            credential: "openrelayproject"
          }
        ]
      }
    });
    
    // Variables globales
    let myPeerId = null;
    let myRole = null; // "host" ou "client"
    let localChoice = null;
    let remoteChoice = null;
    let gameActive = true;
    let conn = null;
    
    peer.on('open', (id) => {
      myPeerId = id;
      document.getElementById('status').textContent = 'Statut : Prêt';
      console.log('Mon ID:', id);
    });
    
    peer.on('error', (err) => {
      document.getElementById('status').textContent = `Erreur : ${err.type}`;
      console.error('Erreur PeerJS:', err);
    });
    
    // Bouton "Créer une partie" (hôte)
    document.getElementById('createLink').onclick = () => {
      myRole = "host";
      navigator.clipboard.writeText(myPeerId);
      document.getElementById('status').textContent =
        `Statut : En attente d’un joueur - ID copié : ${myPeerId}`;
      document.getElementById('player-info').textContent = 'Vous êtes l’hôte (Joueur 1)';
      document.getElementById('player-info').style.color = 'red';
      console.log('Partie créée, ID copié:', myPeerId);
    };
    
    // Bouton "Rejoindre" (client)
    document.getElementById('joinGame').onclick = () => {
      const inviteCode = document.getElementById('inviteCode').value.trim();
      if (!inviteCode) {
        alert("Entrez l'ID de l’hôte !");
        return;
      }
      myRole = "client";
      document.getElementById('status').textContent = 'Statut : Tentative de connexion...';
      document.getElementById('player-info').textContent = 'Vous êtes le joueur 2';
      document.getElementById('player-info').style.color = 'yellow';
      conn = peer.connect(inviteCode);
      setupConnection();
    };
    
    // Quand un client se connecte à moi (hôte)
    peer.on('connection', (connection) => {
      conn = connection;
      document.getElementById('status').textContent = 'Statut : Joueur connecté, jeu prêt !';
      setupConnection();
    });
    
    function setupConnection() {
      conn.on('open', () => {
        document.getElementById('connection-section').style.display = 'none';
        document.getElementById('chifumi-game').style.display = 'block';
        startGame();
        syncState();
        console.log('Connexion établie avec:', conn.peer);
      });
      conn.on('data', (data) => { handleGameData(data); });
      conn.on('error', (err) => {
        document.getElementById('status').textContent = `Erreur de connexion : ${err}`;
        document.getElementById('connection-section').style.display = 'block';
        document.getElementById('chifumi-game').style.display = 'none';
      });
      conn.on('close', () => {
        document.getElementById('status').textContent = 'Connexion perdue';
        document.getElementById('connection-section').style.display = 'block';
        document.getElementById('chifumi-game').style.display = 'none';
      });
    }
    
    function startGame() {
      localChoice = null;
      remoteChoice = null;
      gameActive = true;
      document.getElementById('chifumi-result').textContent = "";
      document.getElementById('chifumi-turn').textContent = "Faites votre choix !";
      document.getElementById('opponent-status').textContent = "L'autre joueur n'a pas encore choisi.";
      document.getElementById('chifumi-restart').style.display = 'none';
      syncState();
    }
    
    function selectChoice(choice) {
      if (!gameActive || localChoice) return;
      localChoice = choice;
      document.getElementById('chifumi-turn').textContent = `Vous avez choisi ${choice}.`;
      conn.send({ type: 'move', choice: choice });
      checkGameState();
    }
    
    function checkGameState() {
      if (localChoice && remoteChoice) {
        determineWinner();
      }
    }
    
    function determineWinner() {
      let result = "";
      if (localChoice === remoteChoice) {
        result = "Égalité !";
      }
      else if (
        (localChoice === "Pierre" && remoteChoice === "Ciseaux") ||
        (localChoice === "Feuille" && remoteChoice === "Pierre") ||
        (localChoice === "Ciseaux" && remoteChoice === "Feuille")
      ) {
        result = (myRole === "host") ? "Vous gagnez !" : "Vous gagnez !";
      } else {
        result = (myRole === "host") ? "Vous perdez !" : "Vous perdez !";
      }
      document.getElementById('chifumi-result').textContent = result;
      gameActive = false;
      document.getElementById('chifumi-restart').style.display = 'block';
    }
    
    function resetGame() {
      localChoice = null;
      remoteChoice = null;
      gameActive = true;
      document.getElementById('chifumi-result').textContent = "";
      document.getElementById('chifumi-turn').textContent = "Faites votre choix !";
      document.getElementById('opponent-status').textContent = "L'autre joueur n'a pas encore choisi.";
      document.getElementById('chifumi-restart').style.display = 'none';
      syncState();
    }
    
    document.getElementById('chifumi-restart').onclick = () => {
      if (!conn || conn.closed) return;
      conn.send({ type: 'restart' });
      resetGame();
    };
    
    function handleGameData(data) {
      if (data.type === 'move') {
        remoteChoice = data.choice;
        document.getElementById('opponent-status').textContent = "L'autre joueur a choisi !";
        checkGameState();
      } else if (data.type === 'restart') {
        resetGame();
      } else if (data.type === 'syncState') {
        // On peut synchroniser l'état si besoin
      }
    }
    
    function syncState() {
      if (conn && !conn.closed) {
        conn.send({
          type: 'syncState',
          localChoice: localChoice
        });
      }
    }
  </script>
</body>
</html>
